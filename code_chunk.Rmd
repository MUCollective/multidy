---
title: "Multiverse code block"
author: "Abhraneel Sarma"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{The most basic multiverse example: calculating the mean}
  %\usepackage[UTF-8]{inputenc}
---


```{r setup, include=FALSE}
library(knitr)
opts_knit$set(echo = TRUE)
#  fig.width = 6, 
#  fig.height = 4,
#  output.dir="vignettes"
#)

library(dplyr)
library(tidyr)
library(purrr)
library(rlang)
library(ggplot2)
library(lme4)
library(multiverse)

M <- multiverse()
```


```{r, block-exec}
custom_block_exec <- function(options) {
  # options$engine <- "R"
  if (options$engine == "R") {
    multiverse:::block_exec_R(options)
  } else if (options$engine == "multiverse") {
    .m_block_params <- lapply(strsplit(gsub("[^A-Za-z0-9,=-]+", "", options$params.src), ","), strsplit, split = "=")
    names <- lapply(unlist(.m_block_params, recursive = FALSE), function(l) l[[1]])
    alist <- lapply(unlist(.m_block_params, recursive = FALSE), function(l) l[[2]])
    names(alist) <- names
    
    # .code = options$code
    .c = multiverse:::multiverse_block_code(alist$inside, alist$label, options$code)
    multiverse:::multiverse_default_block_exec(.c, options)
  }
}

## Hot patch for knitting: re-assign the function in the relevant namespace
environment(custom_block_exec) <- asNamespace('knitr')
assignInNamespace("block_exec", custom_block_exec, ns = "knitr")
```



```{r}
data <- readr::read_csv('data/speed_data.csv')

speed_data <- data %>%
  mutate( speed = num_words / (adjust_rt/60000) ) %>%
  filter( retake != 1 )

head(speed_data)
```

```{multiverse, label = default-m-1, inside = M}
iqr = IQR(speed_data[speed_data$dyslexia_bin == 0,]$speed,na.rm=TRUE)
median = median(speed_data$speed)

result_analysis <- speed_data %>%
  filter(branch(outlier,
    "default" ~ speed < median + 3 * iqr & speed > 10,
    "strict" ~ speed < median + 2 * iqr & speed > 10
  )) %>%
  filter(branch(device,
    "default" ~ device != "smartphone",
    "strict" ~ !device %in% c("smartphone", "other") & !is.na(device)
  )) %>%
  filter( correct_rate > .6 )
```

```{multiverse label = default-m-2, inside = M}
model <- branch(model_spec,
  "default" ~ lmer(log(speed) ~ as.factor(page_condition)*as.factor(dyslexia) + img_width + num_words + age + english_native + (1 | uuid), data = result_analysis),
  "conservative" ~ lmer(log(speed) ~ as.factor(page_condition)*as.factor(dyslexia) + img_width + english_native + (1 | uuid), data = result_analysis),
  "width_dyslexia_interaction" ~ lmer(log(speed) ~ as.factor(page_condition)*as.factor(dyslexia) + img_width*as.factor(dyslexia) + num_words + age + english_native + (1 | uuid), data = result_analysis),
  "width_dyslexia_interaction_conservative" ~ lmer(log(speed) ~ as.factor(page_condition)*as.factor(dyslexia) + img_width*as.factor(dyslexia) + english_native + (1 | uuid), data = result_analysis))

AIC(model)
summary(model)
```



```{r}
multiverse_table(M)
```


