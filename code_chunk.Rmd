---
title: "code_chunk"
author: "Abhraneel Sarma"
date: "11/25/2019"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{The most basic multiverse example: calculating the mean}
  %\usepackage[UTF-8]{inputenc}
---


```{r setup, include=FALSE}
library(knitr)
#opts_knit$set(
#  echo = TRUE,
#  fig.width = 6, 
#  fig.height = 4,
#  output.dir="vignettes"
#)

library(dplyr)
library(tidyr)
library(purrr)
library(rlang)
#library(multiverse)
```


```{r}
M = multiverse()

inside(M, {
  x <- branch( zero_or_one, 0, 1)
  
  y <- matrix(rnorm(16, 0, 5), 8, 2)
  y[,1]
})

multiverse_table(M)$.code
```


```{r}
x <- expr({
  x <- branch( zero_or_one, 0, 1)
  
  y <- matrix(rnorm(16, 0, 5), 8, 2)
  z <- y[,1]
})

identical(lapply(x, get_parameter_code, list(zero_or_one = "0")), list( quote(`{`), quote(x <- 0), quote(y <- matrix(rnorm(16, 0, 5), 8, 2)), quote(z <- y[,1]) ))
```


```{multiverse, label = default-m-1, inside = M}
speed_data <- speed_data %>%
    mutate(speed = branch(speed_calculation, 
      "speed_calculation_option1" ~ num_words/(adjust_rt/60000),
      "speed_calculation_option2" ~ num_words/(rt/60000))
    )

iqr = IQR(speed_data[speed_data$dyslexia_bin == 0,],na.rm=TRUE)
cutoff_high = median(speed_data$speed) +3*iqr #3*iqr=645, cutoff_high = 928

twobelow = mean(speed_data$speed) - 2*sd(speed_data$speed)
twoabove = mean(speed_data$speed) + 2*sd(speed_data$speed)

# remove only if Flesch Kincaid is the same? may be too time consuming for now

speed_data <- speed_data %>%    
    filter(branch(speed_outlier_filtering, 
      "speed_outlier_filtering_option1" ~ speed < 10 | speed > cutoff_high,
      "speed_outlier_filtering_option2" ~ speed < twobelow | speed > twoabove,
    )) %>%
    filter(branch(comprehension_score,
        "comprehension_score,_option1" ~ correct_rate >= 2/3,
        "comprehension_score,_option2" ~ correct_rate >= 1/3
    )) %>%
    mutate(speed = branch(transform_speed,
        "transform_speed_option1" ~ speed,
        "transform_speed_option1" ~ log(speed)
    ))

model <- branch(data_model,
      "model_1" ~ lmer(speed ~ as.factor(page_condition)*as.factor(dyslexia) + img_width + num_words + age + english_native + (1 | uuid), data = result_analysis),
      "model_2" ~ lmer(speed ~ as.factor(page_condition)*as.factor(dyslexia) + img_width + num_words + age + english_native + Flesch_Kincaid + (1 | uuid), data = result_analysis),
      "model_3" ~ lmer(speed ~ as.factor(page_condition)*as.factor(dyslexia) + img_width + num_words + age + english_native + Flesch_Kincaid + (1 | uuid), data = result_analysis))
```

```{r}
multiverse_table(M)
```


